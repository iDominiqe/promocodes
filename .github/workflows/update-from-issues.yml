name: Update Promocodes from Issues

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  update-promocodes:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'promocode')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Update promocodes from issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body;
            console.log('Issue body:', issueBody);
            
            // Парсим данные из issue
            const codeMatch = issueBody.match(/Код:\s*([A-Z0-9]+)/i);
            const rewardMatch = issueBody.match(/Награда:\s*(.+)/i);
            const expiresMatch = issueBody.match(/Действует до:\s*(\d{4}-\d{2}-\d{2})/i);
            const descMatch = issueBody.match(/Описание:\s*(.+)/i);
            
            console.log('Code match:', codeMatch);
            console.log('Reward match:', rewardMatch);
            
            if (codeMatch) {
              const fs = require('fs');
              
              // Читаем текущий JSON
              const currentData = JSON.parse(fs.readFileSync('promocodes.json', 'utf8'));
              
              // Создаем новый промокод
              const newPromo = {
                code: codeMatch[1],
                reward: rewardMatch ? rewardMatch[1].trim() : 'Награда',
                expires: expiresMatch ? expiresMatch[1] : '2024-12-31',
                description: descMatch ? descMatch[1].trim() : '',
                image: ""
              };
              
              console.log('New promo:', newPromo);
              
              // Добавляем в активные
              currentData.active.push(newPromo);
              currentData.last_updated = new Date().toISOString().split('T')[0];
              
              // Сохраняем обратно
              fs.writeFileSync('promocodes.json', JSON.stringify(currentData, null, 2));
              console.log('File updated successfully');
              
              // Коммитим изменения
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '✅ Промокод автоматически добавлен на сайт!'
              });
              
              // Закрываем issue
              await github.rest.issues.update({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              
              console.log('Issue closed and commented');
            } else {
              console.log('No code found in issue');
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '❌ Не удалось найти код промокода. Убедись, что в теле Issue есть строка "Код: ПРОМОКОД"'
              });
            }
            
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add promocodes.json
          git diff --staged --quiet || git commit -m "Auto-update: добавлен промокод из issue #${{ github.event.issue.number }}"
          git push
